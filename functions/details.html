<script>

function verDetalle(id) {
  if (!datosCompletos || !datosCompletos.registros) {
    mostrarNotificacion('No hay datos disponibles para mostrar', 'warning');
    return;
  }
  
  const registro = datosCompletos.registros.find(r => r.ID === id);
  if (registro) {
    const detalles = `
ID: ${registro.ID || '-'}
C√≥digo: ${registro.C√≥digo || '-'}
Tipo de Salida: ${registro['NombreProducto'] || '-'}
Descripci√≥n: ${registro.Descripci√≥n || '-'}
Tipo de Salida: ${registro['Tipo de Salida'] || '-'}
Tipo de Plaga: ${registro['Tipo de Plaga/Hallazgo'] || 'N/A'}
Fecha: ${formatearFecha(registro['Fecha y Hora de Retiro'])}
Responsable: ${registro.Responsable || '-'}
Pasillo: ${registro['Pasillo/Ubicaci√≥n'] || '-'}
Estado: ${registro.Estado || '-'}
    `.trim();
    
    alert('Detalles del Registro:\n\n' + detalles);
  } else {
    mostrarNotificacion('No se encontr√≥ el registro solicitado', 'error');
  }
}

function verDetalle(id) {
  if (!datosCompletos || !datosCompletos.registros) {
    mostrarNotificacion('No hay datos disponibles para mostrar', 'warning');
    return;
  }
  
  const registro = datosCompletos.registros.find(r => r.ID === id);
  
  if (!registro) {
    mostrarNotificacion('No se encontr√≥ el registro solicitado', 'error');
    return;
  }
  
  registroActual = registro;
  cargarOpcionesEstado(); // Cargar opciones para edici√≥n
  mostrarModalDetalles(registro);
}

function mostrarModalDetalles(registro) {
  console.log('üìã Mostrando detalles del registro:', registro);
  
  registroActual = registro;
  
  // Actualizar t√≠tulo
  document.getElementById('tituloCodigo').textContent = registro.C√≥digo || 'Sin c√≥digo';
  
  // Llenar informaci√≥n
  llenarDetallesRegistro(registro);
  
  // Configurar estado actual
  const estadoActual = registro.Estado || 'Desconocido';
  document.getElementById('estadoActualTexto').textContent = estadoActual;
  document.getElementById('estadoActualTexto').className = 'badge ' + obtenerBadgeEstado(estadoActual);
  
  // Resetear formulario
  document.getElementById('editarEstado').value = '';
  document.getElementById('estadoNuevoTexto').textContent = 'Seleccione estado';
  document.getElementById('estadoNuevoTexto').className = 'badge badge-info';
  
  // Ocultar nota inicialmente
  const notaDevolucion = document.querySelector('.nota-devolucion');
  if (notaDevolucion) {
    notaDevolucion.style.display = 'none';
  }
  
  // Cargar opciones de estado FILTRADAS seg√∫n rol
  console.log('üîÑ Cargando opciones de estado filtradas...');
  cargarOpcionesEstado();
  
  // Mostrar pesta√±a de detalles
  cambiarPestania('detalles');
  
  // Mostrar modal
  document.getElementById('modalDetalles').classList.add('active');
  
  console.log('‚úÖ Modal de detalles mostrado');
}

function llenarDetallesRegistro(registro) {
  console.log('üìã Llenando detalles del registro:', registro);
  
  // Informaci√≥n b√°sica
  document.getElementById('detalleId').textContent = registro.ID || '-';
  document.getElementById('detalleCodigo').textContent = registro.C√≥digo || '-';
  document.getElementById('detalleNombre').textContent = registro['NombreProducto'] || '-';
  document.getElementById('detalleDescripcion').textContent = registro.Descripci√≥n || '-';
  
  // Clasificaci√≥n
  document.getElementById('detalleTipoSalida').textContent = registro['Tipo de Salida'] || '-';
  document.getElementById('detalleTipoPlaga').textContent = registro['Tipo de Plaga/Hallazgo'] || 'N/A';
  
  // Estado - CORREGIDO: usar solo el estado sin fecha para el badge principal
  const estadoElement = document.getElementById('detalleEstado');
  const estado = registro.Estado || '-';
  estadoElement.textContent = estado;
  estadoElement.className = 'badge ' + obtenerBadgeEstado(estado);
  
  // NUEVO: Mostrar "Devuelto a" si existe y el estado es "Devuelto"
  const devueltoElement = document.getElementById('detalledevuelto');
  const devueltoA = registro.DevueltoA || registro.devueltoA || '';
  
  if (estado.toLowerCase() === 'devuelto' && devueltoA) {
    devueltoElement.textContent = devueltoA;
    devueltoElement.style.color = 'var(--success)';
    devueltoElement.style.fontWeight = '500';
  } else {
    devueltoElement.textContent = 'No aplica';
    devueltoElement.style.color = 'var(--gray-500)';
    devueltoElement.style.fontStyle = 'italic';
  }
  
  // Responsable y ubicaci√≥n
  document.getElementById('detalleResponsable').textContent = registro.Responsable || '-';
  document.getElementById('detallePasillo').textContent = registro['Pasillo/Ubicaci√≥n'] || '-';
  
  // Fecha de retorno y estado de vencimiento - VERIFICAR QUE EXISTAN LOS ELEMENTOS
  const fechaRetorno = registro['Tiempo Estimado de Retorno'] || '-';
  const detalleFechaRetorno = document.getElementById('detalleFechaRetorno');
  const detalleEstadoVencimiento = document.getElementById('detalleEstadoVencimiento');
  
  if (detalleFechaRetorno) {
    detalleFechaRetorno.textContent = formatearFechaSimple(fechaRetorno);
  }
  
  if (detalleEstadoVencimiento) {
    const estadoVencimiento = calcularEstadoVencimiento(fechaRetorno, estado);
    detalleEstadoVencimiento.textContent = estadoVencimiento.texto;
    detalleEstadoVencimiento.className = 'badge ' + estadoVencimiento.clase;
  }
  
  // Fechas
  const fechaRetiro = registro['Fecha y Hora de Retiro'] || registro.Fecha;
  document.getElementById('detalleFecha').textContent = formatearFecha(fechaRetiro);
  document.getElementById('detalleTiempoTranscurrido').textContent = calcularTiempoTranscurrido(fechaRetiro);
  
  // Debug: verificar que los datos se est√°n cargando
  console.log('üìÖ Fecha de retorno cargada:', fechaRetorno);
  console.log('üè∑Ô∏è Estado cargado:', estado);
  console.log('üë§ Devuelto a cargado:', devueltoA);
}

</script>