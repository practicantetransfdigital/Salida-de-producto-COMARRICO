<script>
    function cargarDashboard() {
  console.log('üîÑ Iniciando carga de dashboard...');
  mostrarLoading(true);
  
  const timeoutId = setTimeout(() => {
    mostrarLoading(false);
    mostrarNotificacion('La carga est√° tardando demasiado. Verifique su conexi√≥n.', 'warning');
  }, 15000);
  
  timeoutIds.push(timeoutId);
  
  google.script.run
    .withSuccessHandler((resultado) => {
      clearTimeout(timeoutId);
      respuestaDashboard(resultado);
    })
    .withFailureHandler((error) => {
      clearTimeout(timeoutId);
      errorDashboard(error);
    })
    .obtenerDatosDashboard();
  
  // Cargar opciones para el formulario en paralelo
  cargarOpcionesFormulario();
}

function respuestaDashboard(resultado) {
  console.log('‚úÖ Respuesta del dashboard:', resultado);
  mostrarLoading(false);
  
  // MANEJO MEJORADO DE RESPUESTA NULL
  if (resultado === null || resultado === undefined) {
    console.error('‚ùå ERROR: El servidor devolvi√≥ null/undefined');
    mostrarNotificacion('Error: El servidor no respondi√≥ correctamente. Verifique la conexi√≥n y los permisos.', 'error');
    
    // Mostrar datos de ejemplo para debugging
    mostrarDatosEjemplo();
    return;
  }
  
  // Si es string, parsear JSON
  if (typeof resultado === 'string') {
    try {
      resultado = JSON.parse(resultado);
    } catch (e) {
      console.error('‚ùå Error parseando JSON:', e);
      mostrarNotificacion('Error: Respuesta inv√°lida del servidor', 'error');
      return;
    }
  }
  
  if (!resultado || typeof resultado !== 'object') {
    console.error('‚ùå Error: Respuesta inv√°lida:', resultado);
    mostrarNotificacion('Error: Formato de respuesta inv√°lido', 'error');
    return;
  }
  
  if (resultado.success === false) {
    console.error('‚ùå Error del servidor:', resultado.message);
    mostrarNotificacion('Error: ' + resultado.message, 'error');
    return;
  }
  
  if (resultado.success === true) {
    console.log('‚úÖ Dashboard cargado exitosamente');
    datosCompletos = resultado;
    actualizarEstadisticas(resultado.estadisticas || {});
    crearGraficos(resultado.estadisticas || {});
    cargarTabla((resultado.estadisticas && resultado.estadisticas.ultimosRegistros) || []);
    mostrarNotificacion('Dashboard actualizado correctamente', 'success');
  } else {
    console.error('‚ùå Respuesta sin propiedad success:', resultado);
    mostrarNotificacion('Error: Formato de respuesta inv√°lido', 'error');
  }
}

function errorDashboard(error) {
  mostrarLoading(false);
  console.error('‚ùå Error del servidor:', error);
  
  let mensaje = 'Error del servidor: ' + (error.message || 'Error desconocido');
  mensaje += '\n\nSugerencias:';
  mensaje += '\n‚Ä¢ Verifique su conexi√≥n a internet';
  mensaje += '\n‚Ä¢ Confirme que la aplicaci√≥n est√© desplegada';
  mensaje += '\n‚Ä¢ Contacte al administrador del sistema';
  
  mostrarNotificacion(mensaje, 'error');
}
</script>