<script>

  function cargarOpcionesFormulario() {
  console.log('üìã Cargando opciones para formularios...');
  
  google.script.run
    .withSuccessHandler((resultado) => {
      console.log('‚úÖ Opciones recibidas del servidor:', resultado);
      
      if (!resultado || typeof resultado !== 'object') {
        console.error('‚ùå Opciones inv√°lidas:', resultado);
        usarOpcionesPorDefecto();
        return;
      }
      
      if (resultado.success === false) {
        console.error('‚ùå Error del servidor:', resultado.message);
        usarOpcionesPorDefecto();
        return;
      }
      
      // Cargar tipos de salida
      if (resultado.tiposSalida && Array.isArray(resultado.tiposSalida)) {
        llenarSelect('tipoSalida', resultado.tiposSalida);
      } else {
        console.warn('‚ö†Ô∏è Tipos de salida no disponibles');
        llenarSelect('tipoSalida', [
          'Control de Calidad', 
          'Gasificaci√≥n', 
          'Destrucci√≥n', 
          'Para Revisi√≥n', 
          'Reproceso', 
          'Devoluci√≥n a Proveedor', 
          'Otro'
        ]);
      }
      
      // Cargar tipos de plaga
      if (resultado.tiposPlagas && Array.isArray(resultado.tiposPlagas)) {
        llenarSelect('tipoPlaga', resultado.tiposPlagas);
      } else {
        console.warn('‚ö†Ô∏è Tipos de plaga no disponibles');
        llenarSelect('tipoPlaga', [
          'N/A',
          'Insectos',
          'Roedores', 
          'Hongos',
          'Contaminaci√≥n',
          'Otro'
        ]);
      }
      
      // Cargar estados seg√∫n el rol del usuario
      let estadosDisponibles = [];
      
      if (usuarioActual && usuarioActual.rol) {
        const rol = usuarioActual.rol.toLowerCase();
        
        if (rol === 'administrador' || rol === 'admin') {
          // Administrador: todos los estados
          estadosDisponibles = resultado.estados || [
            'En Revisi√≥n',
            'Devuelto',
            'Pendiente por Devoluci√≥n',
            'Procesado',
            'Destruido'
          ];
          console.log('üõ°Ô∏è Administrador: mostrando todos los estados');
        } else {
          // Calidad: solo 3 estados
          estadosDisponibles = ['En Revisi√≥n', 'Devuelto', 'Pendiente por Devoluci√≥n'];
          console.log('üîß Calidad: mostrando solo 3 estados');
        }
      } else {
        // Sin usuario: solo estados b√°sicos
        estadosDisponibles = ['En Revisi√≥n', 'Devuelto', 'Pendiente por Devoluci√≥n'];
        console.log('‚ö†Ô∏è Sin usuario: mostrando estados b√°sicos');
      }
      
      llenarSelect('estado', estadosDisponibles);
      
      // Establecer valores por defecto
      document.getElementById('tipoPlaga').value = 'N/A';
      
      if (usuarioActual && usuarioActual.rol) {
        const rol = usuarioActual.rol.toLowerCase();
        if (rol !== 'administrador' && rol !== 'admin') {
          // Calidad: por defecto "En Revisi√≥n"
          document.getElementById('estado').value = 'En Revisi√≥n';
        }
      } else {
        document.getElementById('estado').value = 'En Revisi√≥n';
      }
      
      console.log('‚úÖ Opciones de formulario cargadas correctamente');
    })
    .withFailureHandler((error) => {
      console.error('‚ùå Error al cargar opciones:', error);
      usarOpcionesPorDefecto();
    })
    .obtenerOpciones();
}

function usarOpcionesPorDefecto() {
  console.log('‚ö†Ô∏è Usando opciones por defecto...');
  
  // Tipos de salida por defecto
  llenarSelect('tipoSalida', [
    'Control de Calidad', 
    'Gasificaci√≥n', 
    'Destrucci√≥n', 
    'Para Revisi√≥n', 
    'Reproceso', 
    'Devoluci√≥n a Proveedor', 
    'Otro'
  ]);
  
  // Tipos de plaga por defecto
  llenarSelect('tipoPlaga', [
    'N/A',
    'Insectos',
    'Roedores', 
    'Hongos',
    'Contaminaci√≥n',
    'Otro'
  ]);
  
  // Estados seg√∫n rol del usuario
  let estadosDisponibles = [];
  
  if (usuarioActual && usuarioActual.rol) {
    const rol = usuarioActual.rol.toLowerCase();
    
    if (rol === 'administrador' || rol === 'admin') {
      estadosDisponibles = ['En Revisi√≥n', 'Devuelto', 'Pendiente por Devoluci√≥n', 'Procesado', 'Destruido'];
    } else {
      estadosDisponibles = ['En Revisi√≥n', 'Devuelto', 'Pendiente por Devoluci√≥n'];
    }
  } else {
    estadosDisponibles = ['En Revisi√≥n', 'Devuelto', 'Pendiente por Devoluci√≥n'];
  }
  
  llenarSelect('estado', estadosDisponibles);
  
  // Valores por defecto
  document.getElementById('tipoPlaga').value = 'N/A';
  document.getElementById('estado').value = 'En Revisi√≥n';
  
  console.log('‚úÖ Opciones por defecto cargadas');
}
    
function abrirModalRegistro() {
  document.getElementById('modalRegistro').classList.add('active');
  document.getElementById('formRegistro').reset();
  
  // Establecer valores por defecto
  document.getElementById('estado').value = 'En Revisi√≥n';
  document.getElementById('tipoPlaga').value = 'N/A';
  
  // Establecer fecha m√≠nima como hoy para el campo de fecha
  const fechaInput = document.getElementById('fechaRetorno');
  if (fechaInput) {
    const hoy = new Date();
    
    // CORRECCI√ìN: Formatear fecha correctamente para input type="date"
    const fechaHoy = hoy.toISOString().split('T')[0];
    fechaInput.min = fechaHoy;
    
    // Establecer fecha por defecto (3 d√≠as despu√©s)
    const fechaDefecto = new Date();
    fechaDefecto.setDate(hoy.getDate() + 3);
    const fechaDefectoStr = fechaDefecto.toISOString().split('T')[0];
    fechaInput.value = fechaDefectoStr;
  }
}

function cerrarModalRegistro() {
  // 1. Cerrar el modal
  document.getElementById('modalRegistro').classList.remove('active');
  
  // 2. Limpiar el formulario (por si acaso)
  setTimeout(() => {
    document.getElementById('formRegistro').reset();
    
    // 3. Restablecer valores por defecto
    document.getElementById('estado').value = 'En Revisi√≥n';
    document.getElementById('tipoPlaga').value = 'N/A';
  }, 300);
}

function guardarRegistro(event) {
  if (event) event.preventDefault();
  
  const btnGuardar = document.querySelector('#formRegistro button[type="submit"]');
  const textoOriginal = btnGuardar.innerHTML;
  btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
  btnGuardar.disabled = true;
  
  // Validar fecha de retorno
  const fechaRetornoInput = document.getElementById('fechaRetorno');
  const fechaRetornoValor = fechaRetornoInput.value;
  
  if (!fechaRetornoValor) {
    mostrarNotificacion('La fecha de retorno es requerida', 'error');
    btnGuardar.innerHTML = textoOriginal;
    btnGuardar.disabled = false;
    return;
  }
  
  // Obtener valores del formulario
  const codigo = document.getElementById('codigo').value.trim();
  const nombreProducto = document.getElementById('nombreproducto').value.trim();
  const descripcion = document.getElementById('descripcion').value.trim();
  const tipoSalida = document.getElementById('tipoSalida').value;
  const tipoPlaga = document.getElementById('tipoPlaga').value;
  const responsable = document.getElementById('responsable').value.trim();
  const pasillo = document.getElementById('pasillo').value.trim();
  const estado = document.getElementById('estado').value;
  
  // üéØ NORMALIZAR DATOS ANTES DE ENVIAR
  const datos = {
    'C√≥digo': codigo,
    'NombreProducto': nombreProducto,
    'Descripci√≥n': descripcion,
    'Tipo de Salida': tipoSalida,
    'Tipo de Plaga/Hallazgo': tipoPlaga,
    'Responsable': responsable,
    'Pasillo/Ubicaci√≥n': normalizarUbicacion(pasillo), // üéØ AQU√ç SE NORMALIZA
    'Fecha Estimada de Retorno': fechaRetornoValor,
    'Estado': estado
  };
  
  console.log('üìù Datos normalizados para guardar:', datos);
  
  // Validar campos requeridos
  const camposRequeridos = ['C√≥digo', 'NombreProducto', 'Descripci√≥n', 'Tipo de Salida', 'Responsable', 'Pasillo/Ubicaci√≥n', 'Fecha Estimada de Retorno', 'Estado'];
  const camposFaltantes = camposRequeridos.filter(campo => !datos[campo]);
  
  if (camposFaltantes.length > 0) {
    mostrarNotificacion('Por favor complete todos los campos requeridos', 'error');
    btnGuardar.innerHTML = textoOriginal;
    btnGuardar.disabled = false;
    return;
  }
  
  mostrarLoading(true);
  
  const timeoutId = setTimeout(() => {
    mostrarLoading(false);
    btnGuardar.innerHTML = textoOriginal;
    btnGuardar.disabled = false;
    mostrarNotificacion('El registro est√° tardando demasiado. Intente nuevamente.', 'warning');
  }, 10000);
  
  google.script.run
    .withSuccessHandler((resultado) => {
      clearTimeout(timeoutId);
      respuestaGuardar(resultado, btnGuardar, textoOriginal);
    })
    .withFailureHandler((error) => {
      clearTimeout(timeoutId);
      errorGuardar(error, btnGuardar, textoOriginal);
    })
    .registrarSalida(datos);
}

function respuestaGuardar(resultado, btnGuardar, textoOriginal) {
  console.log('üìù Respuesta de guardar:', resultado);
  console.log('üìù Tipo de respuesta:', typeof resultado);
  mostrarLoading(false);
  
  // REHABILITAR bot√≥n siempre
  if (btnGuardar) {
    btnGuardar.innerHTML = textoOriginal;
    btnGuardar.disabled = false;
  }
  
  // ‚úÖ CORRECCI√ìN MEJORADA: Manejar tanto objetos como strings JSON
  let respuestaFinal = resultado;
  
  // Si es string, intentar parsear
  if (typeof resultado === 'string') {
    try {
      respuestaFinal = JSON.parse(resultado);
      console.log('üìä Respuesta parseada:', respuestaFinal);
    } catch (e) {
      console.error('‚ùå Error parseando JSON:', e);
      mostrarNotificacion('Error: Respuesta inv√°lida del servidor', 'error');
      return;
    }
  }
  
  if (!respuestaFinal || typeof respuestaFinal !== 'object') {
    console.error('‚ùå Error: Respuesta inv√°lida:', respuestaFinal);
    mostrarNotificacion('Error: Formato de respuesta inv√°lido', 'error');
    return;
  }
  
  // ‚úÖ VERIFICAR SI FUE EXITOSO
  if (respuestaFinal.success === true) {
    console.log('‚úÖ Registro exitoso, ID:', respuestaFinal.id);
    
    // 1. Cerrar el modal
    cerrarModalRegistro();
    
    // 2. Limpiar el formulario
    document.getElementById('formRegistro').reset();
    
    // 3. Mostrar alerta de √âXITO (verde)
    mostrarNotificacion(`‚úÖ Salida registrada correctamente con ID: ${respuestaFinal.id}`, 'success');
    
    // 4. Actualizar el dashboard autom√°ticamente
    setTimeout(() => {
      cargarDashboard();
    }, 1500); // Esperar 1.5 segundos antes de actualizar
    
  } else {
    // ‚ùå Mostrar error si fall√≥
    console.error('‚ùå Error en registro:', respuestaFinal.message);
    mostrarNotificacion('‚ùå Error al registrar: ' + (respuestaFinal.message || 'Error desconocido'), 'error');
  }
}

function errorGuardar(error, btnGuardar, textoOriginal) {
  mostrarLoading(false);
  
  // REHABILITAR bot√≥n siempre
  if (btnGuardar) {
    btnGuardar.innerHTML = textoOriginal;
    btnGuardar.disabled = false;
  }
  
  console.error('‚ùå Error del servidor:', error);
  mostrarNotificacion('Error del servidor: ' + (error.message || 'Error desconocido'), 'error');
}

function configurarEventoCambioEstado() {
  const selectEstado = document.getElementById('editarEstado');
  const notaDevolucion = document.querySelector('.nota-devolucion');
  
  if (!selectEstado) return;
  
  // Clonar y reemplazar para evitar duplicaci√≥n de event listeners
  const nuevoSelect = selectEstado.cloneNode(true);
  if (selectEstado.parentNode) {
    selectEstado.parentNode.replaceChild(nuevoSelect, selectEstado);
  }
  
  // Agregar event listener al nuevo select
  nuevoSelect.addEventListener('change', function() {
    const nuevoEstado = this.value;
    const estadoNuevoElement = document.getElementById('estadoNuevoTexto');
    
    if (nuevoEstado) {
      estadoNuevoElement.textContent = nuevoEstado;
      estadoNuevoElement.className = 'badge ' + obtenerBadgeEstado(nuevoEstado);
      
      // Mostrar nota si es "Devuelto"
      if (notaDevolucion) {
        if (nuevoEstado.toLowerCase() === 'devuelto') {
          notaDevolucion.style.display = 'block';
        } else {
          notaDevolucion.style.display = 'none';
        }
      }
    } else {
      estadoNuevoElement.textContent = 'Seleccione estado';
      estadoNuevoElement.className = 'badge badge-info';
      if (notaDevolucion) {
        notaDevolucion.style.display = 'none';
      }
    }
  });
}

function configurarEventoCambioEstado() {
  const selectEstado = document.getElementById('editarEstado');
  const notaDevolucion = document.querySelector('.nota-devolucion');
  
  if (!selectEstado) return;
  
  // Remover event listeners anteriores
  const nuevoSelect = selectEstado.cloneNode(true);
  selectEstado.parentNode.replaceChild(nuevoSelect, selectEstado);
  
  // Agregar nuevo event listener
  nuevoSelect.addEventListener('change', function() {
    const nuevoEstado = this.value;
    const estadoNuevoElement = document.getElementById('estadoNuevoTexto');
    
    if (nuevoEstado) {
      estadoNuevoElement.textContent = nuevoEstado;
      estadoNuevoElement.className = 'badge ' + obtenerBadgeEstado(nuevoEstado);
      
      // Mostrar/ocultar nota sobre devoluci√≥n
      if (notaDevolucion) {
        if (nuevoEstado.toLowerCase() === 'devuelto') {
          notaDevolucion.style.display = 'block';
        } else {
          notaDevolucion.style.display = 'none';
        }
      }
    } else {
      estadoNuevoElement.textContent = 'Seleccione estado';
      estadoNuevoElement.className = 'badge badge-info';
      if (notaDevolucion) {
        notaDevolucion.style.display = 'none';
      }
    }
  });
}
</script>