<script>

  // Ejecuta esto desde la consola para ver qu√© pasa
function verificarEstados() {
  console.log('=== VERIFICACI√ìN ===');
  console.log('Usuario:', usuarioActual);
  console.log('Rol:', usuarioActual?.rol);
  
  const select = document.getElementById('editarEstado');
  if (!select) {
    console.log('‚ùå Select no encontrado');
    return;
  }
  
  console.log('Opciones en el select:');
  for (let i = 0; i < select.options.length; i++) {
    console.log(`  [${i}] ${select.options[i].text}`);
  }
  console.log('=== FIN ===');
}
    
function iniciarSesion() {
  const usuario = document.getElementById('usuario').value.trim();
  const contrasena = document.getElementById('contrasena').value;
  
  if (!usuario || !contrasena) {
    mostrarError('Por favor complete todos los campos');
    return;
  }
  
  mostrarLoading(true);
  
  const timeoutId = setTimeout(() => {
    mostrarLoading(false);
    mostrarError('La autenticaci√≥n est√° tardando demasiado. Verifique su conexi√≥n.');
  }, 10000);
  
  timeoutIds.push(timeoutId);
  
  google.script.run
    .withSuccessHandler((resultado) => {
      clearTimeout(timeoutId);
      respuestaLogin(resultado);
    })
    .withFailureHandler((error) => {
      clearTimeout(timeoutId);
      errorServidor(error);
    })
    .autenticarUsuario(usuario, contrasena);
}

function respuestaLogin(resultado) {
  mostrarLoading(false); // Ocultar loading del login
  
  if (resultado && resultado.success) {
    usuarioActual = resultado;
    document.getElementById('userName').textContent = resultado.nombre || resultado.usuario;
    
    // Calcular permisos seg√∫n el rol
    if (!usuarioActual.permisos) {
      usuarioActual.permisos = obtenerPermisosPorRol(usuarioActual.rol);
    }
    
    const userRoleElement = document.getElementById('userRole');
    const rol = resultado.rol;
    
    userRoleElement.textContent = rol;
    
    // Asignar color seg√∫n rol
    if (rol.toLowerCase() === 'administrador' || rol.toLowerCase() === 'admin') {
      userRoleElement.className = 'badge badge-error';
    } else {
      userRoleElement.className = 'badge badge-success';
    }
    
    // Cambiar a la pantalla principal
    cambiarPantalla('mainScreen');
    
    // Cargar dashboard
    mostrarLoading(true);
    console.log('üöÄ Iniciando carga inmediata del dashboard...');
    cargarDashboard();
    
    // Limpiar formulario de login
    document.getElementById('usuario').value = '';
    document.getElementById('contrasena').value = '';
    limpiarError();
  } else {
    mostrarError(resultado?.message || 'Error desconocido en autenticaci√≥n');
  }
}

// Funci√≥n para obtener permisos seg√∫n el rol
function obtenerPermisosPorRol(rol) {
  const rolLower = rol ? rol.toLowerCase() : 'calidad';
  
  if (rolLower === 'administrador' || rolLower === 'admin') {
    return ['En Revisi√≥n', 'Devuelto', 'Pendiente por Devoluci√≥n', 'Procesado', 'Destruido'];
  } else {
    // Para calidad o cualquier otro rol
    return ['En Revisi√≥n', 'Devuelto', 'Pendiente por Devoluci√≥n'];
  }
}

function cerrarSesion() {
  // Limpiar todos los timeouts pendientes
  timeoutIds.forEach(id => clearTimeout(id));
  timeoutIds = [];
  
  // Destruir gr√°ficos
  Object.values(charts).forEach(chart => {
    if (chart && typeof chart.destroy === 'function') {
      chart.destroy();
    }
  });
  charts = {};
  
  usuarioActual = null;
  datosCompletos = null;
  mostrarNotificacion('Sesi√≥n cerrada correctamente', 'info')
  cambiarPantalla('loginScreen');
}
</script>