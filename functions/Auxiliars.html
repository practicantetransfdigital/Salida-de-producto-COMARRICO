<script>
    function cambiarPantalla(idPantalla) {
  document.querySelectorAll('.screen').forEach(screen => {
    screen.classList.remove('active');
  });
  document.getElementById(idPantalla).classList.add('active');
}

function mostrarLoading(mostrar) {
  const spinner = document.getElementById('loadingSpinner');
  if (mostrar) {
    spinner.classList.add('active');
  } else {
    spinner.classList.remove('active');
  }
}

function mostrarError(mensaje) {
  const errorDiv = document.getElementById('loginError');
  if (errorDiv) {
    errorDiv.textContent = mensaje;
    errorDiv.style.display = 'block';
  }
}

function limpiarError() {
  const errorDiv = document.getElementById('loginError');
  if (errorDiv) {
    errorDiv.textContent = '';
    errorDiv.style.display = 'none';
  }
}

function errorServidor(error) {
  mostrarLoading(false);
  console.error('❌ Error del servidor:', error);
  mostrarNotificacion('Error del servidor: ' + (error.message || 'Error desconocido'), 'error');
}

function mostrarNotificacion(mensaje, tipo = 'info') {
  // Crear notificación temporal
  const notificacion = document.createElement('div');
  notificacion.className = `notificacion notificacion-${tipo}`;
  notificacion.innerHTML = `
    <div class="notificacion-contenido">
      <span class="notificacion-mensaje">${mensaje}</span>
      <button class="notificacion-cerrar" onclick="this.parentElement.parentElement.remove()">×</button>
    </div>
  `;
  
  // Estilos básicos para notificación
  notificacion.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${tipo === 'error' ? '#F56565' : tipo === 'success' ? '#48BB78' : tipo === 'warning' ? '#ED8936' : '#4299E1'};
    color: white;
    padding: 12px 16px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10000;
    max-width: 400px;
    animation: slideIn 0.3s ease-out;
  `;
  
  document.body.appendChild(notificacion);
  
  // Auto-remover después de 5 segundos
  setTimeout(() => {
    if (notificacion.parentElement) {
      notificacion.remove();
    }
  }, 5000);
}

function obtenerBadgeEstado(estado) {
  const badges = {
    'En Revisión': 'badge-warning',
    'Devuelto': 'badge-success',
    'Pendiente por Devolución': 'badge-error',
    'Procesado': 'badge-info',
    'Destruido': 'badge-error'
  };
  
  return badges[estado] || 'badge-info';
}

function formatearFecha(fecha) {
  if (!fecha) return '-';
  
  // Si ya es una fecha formateada, devolverla tal cual
  if (typeof fecha === 'string' && fecha.match(/\d{2}\/\d{2}\/\d{4}/)) {
    return fecha;
  }
  
  try {
    const d = new Date(fecha);
    if (isNaN(d.getTime())) return fecha;
    
    const dia = String(d.getDate()).padStart(2, '0');
    const mes = String(d.getMonth() + 1).padStart(2, '0');
    const año = d.getFullYear();
    const hora = String(d.getHours()).padStart(2, '0');
    const min = String(d.getMinutes()).padStart(2, '0');
    
    return `${dia}/${mes}/${año} ${hora}:${min}`;
  } catch (error) {
    console.error('Error formateando fecha:', error, fecha);
    return fecha;
  }
}

function verDetalle(id) {
  if (!datosCompletos || !datosCompletos.registros) {
    mostrarNotificacion('No hay datos disponibles para mostrar', 'warning');
    return;
  }
  
  const registro = datosCompletos.registros.find(r => r.ID === id);
  if (registro) {
    const detalles = `
ID: ${registro.ID || '-'}
Código: ${registro.Código || '-'}
Descripción: ${registro.Descripción || '-'}
Tipo de Salida: ${registro['Tipo de Salida'] || '-'}
Tipo de Plaga: ${registro['Tipo de Plaga/Hallazgo'] || 'N/A'}
Fecha: ${formatearFecha(registro['Fecha y Hora de Retiro'])}
Responsable: ${registro.Responsable || '-'}
Pasillo: ${registro['Pasillo/Ubicación'] || '-'}
Estado: ${registro.Estado || '-'}
    `.trim();
    
    alert('Detalles del Registro:\n\n' + detalles);
  } else {
    mostrarNotificacion('No se encontró el registro solicitado', 'error');
  }
}

function cambiarPestania(pestania) {
  pestaniaActual = pestania;
  
  // Actualizar botones de pestañas
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
  
  // Activar pestaña seleccionada
  event.target.classList.add('active');
  document.getElementById('contenido' + pestania.charAt(0).toUpperCase() + pestania.slice(1)).classList.add('active');
  
  // Actualizar texto del botón guardar
  const btnGuardar = document.getElementById('btnGuardarCambio');
  if (pestania === 'detalles') {
    btnGuardar.innerHTML = '<i class="fas fa-save"></i> Guardar Cambio';
    btnGuardar.style.display = 'none';
  } else {
    btnGuardar.innerHTML = '<i class="fas fa-save"></i> Actualizar Estado';
    btnGuardar.style.display = 'inline-flex';
  }
}

function calcularTiempoTranscurrido(fecha) {
  if (!fecha) return '-';
  
  try {
    const fechaRegistro = new Date(fecha);
    if (isNaN(fechaRegistro.getTime())) return '-';
    
    const ahora = new Date();
    const diferencia = ahora - fechaRegistro;
    
    const minutos = Math.floor(diferencia / (1000 * 60));
    const horas = Math.floor(minutos / 60);
    const dias = Math.floor(horas / 24);
    
    if (dias > 0) return `${dias} día${dias > 1 ? 's' : ''}`;
    if (horas > 0) return `${horas} hora${horas > 1 ? 's' : ''}`;
    if (minutos > 0) return `${minutos} minuto${minutos > 1 ? 's' : ''}`;
    return 'Hace unos momentos';
  } catch (error) {
    return '-';
  }
}

function cerrarModalDetalles() {
  document.getElementById('modalDetalles').classList.remove('active');
  registroActual = null;
  pestaniaActual = 'detalles';
}

</script>