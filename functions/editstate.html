<script>

function cargarOpcionesEstado() {
  console.log('üîß Cargando opciones de estado para modal de detalles...');
  
  const selectEstado = document.getElementById('editarEstado');
  if (!selectEstado) {
    console.error('‚ùå Select no encontrado');
    return;
  }
  
  // Limpiar select
  selectEstado.innerHTML = '<option value="">Seleccione nuevo estado...</option>';
  
  // DEFINIR QU√â ESTADOS MOSTRAR SEG√öN ROL
  let estadosAMostrar = [];
  
  if (usuarioActual && usuarioActual.rol) {
    const rol = usuarioActual.rol.toLowerCase();
    console.log('üé≠ Rol detectado:', rol);
    
    // Si es administrador
    if (rol === 'administrador' || rol === 'admin') {
      estadosAMostrar = ['En Revisi√≥n', 'Devuelto', 'Pendiente por Devoluci√≥n', 'Procesado', 'Destruido'];
      console.log('üëë Administrador: mostrando 5 estados');
    } 
    // Si NO es administrador (calidad)
    else {
      estadosAMostrar = ['En Revisi√≥n', 'Devuelto', 'Pendiente por Devoluci√≥n'];
      console.log('üîß Calidad: mostrando SOLO 3 estados');
    }
  } else {
    // Por defecto (sin usuario)
    estadosAMostrar = ['En Revisi√≥n', 'Devuelto', 'Pendiente por Devoluci√≥n'];
    console.log('‚ö†Ô∏è Sin usuario: mostrando 3 estados');
  }
  
  console.log('üìã Estados a mostrar:', estadosAMostrar);
  
  // AGREGAR SOLO LOS ESTADOS PERMITIDOS
  estadosAMostrar.forEach(estado => {
    const option = document.createElement('option');
    option.value = estado;
    option.textContent = estado;
    selectEstado.appendChild(option);
  });
  
  // Configurar evento para vista previa (igual que antes)
  selectEstado.addEventListener('change', function() {
    const nuevoEstado = this.value;
    const estadoNuevoElement = document.getElementById('estadoNuevoTexto');
    
    if (nuevoEstado) {
      estadoNuevoElement.textContent = nuevoEstado;
      estadoNuevoElement.className = 'badge ' + obtenerBadgeEstado(nuevoEstado);
    } else {
      estadoNuevoElement.textContent = 'Seleccione estado';
      estadoNuevoElement.className = 'badge badge-info';
    }
  });
  
  console.log('‚úÖ Select cargado con', estadosAMostrar.length, 'estados');
}

async function guardarCambioEstado() {
  console.log('üîÑ Guardando cambio de estado...');
  
  if (!registroActual) {
    mostrarNotificacion('‚ùå No hay registro seleccionado', 'error');
    return;
  }

  const nuevoEstado = document.getElementById('editarEstado').value;
  
  // Validar estado seleccionado
  if (!nuevoEstado) {
    mostrarNotificacion('‚ùå Por favor seleccione un nuevo estado', 'error');
    return;
  }
  
  // Validar si es el mismo estado
  if (nuevoEstado === registroActual.Estado) {
    mostrarNotificacion('‚ùå El estado seleccionado es el mismo que el actual', 'warning');
    return;
  }
  
  // Validar que el usuario tenga permiso para este estado
  if (usuarioActual && usuarioActual.rol) {
    const rol = usuarioActual.rol.toLowerCase();
    
    if (rol !== 'administrador' && rol !== 'admin') {
      // Para calidad, solo permitir 3 estados
      const estadosPermitidosCalidad = ['En Revisi√≥n', 'Devuelto', 'Pendiente por Devoluci√≥n'];
      
      if (!estadosPermitidosCalidad.includes(nuevoEstado)) {
        mostrarNotificacion('‚ùå No tiene permiso para usar este estado', 'error');
        return;
      }
    }
  }
  
  // Si el estado es "Devuelto", abrir modal de devoluci√≥n
  if (nuevoEstado.toLowerCase() === 'devuelto') {
    console.log('üì¶ Estado "Devuelto" seleccionado, abriendo modal de devoluci√≥n');
    abrirModalDevolucion();
    return;
  }
  
  // Para otros estados, usar confirmaci√≥n
  const confirmado = await confirmar(`¬øEst√° seguro de cambiar el estado a "${nuevoEstado}"?`);
  
  if (!confirmado) {
    return;
  }
  
  mostrarLoading(true);

  const nombreUser = usuarioActual ? usuarioActual.nombre : 'Sistema';
  
  google.script.run
    .withSuccessHandler(function(resultado) {
      mostrarLoading(false);
      
      if (typeof resultado === 'string') {
        try {
          resultado = JSON.parse(resultado);
        } catch (e) {
          console.error('Error parseando respuesta:', e);
          mostrarNotificacion('‚ùå Error en formato de respuesta', 'error');
          return;
        }
      }
      
      if (resultado && resultado.success) {
        mostrarNotificacion('‚úÖ Estado actualizado correctamente', 'success');
        
        cargarDashboard();
        
        if (pestaniaActual === 'historial' && registroActual) {
          cargarHistorialObservaciones(registroActual.ID);
        }
        
        cerrarModalDetalles();
      } else {
        mostrarNotificacion('‚ùå Error al actualizar estado: ' + (resultado?.message || 'Error desconocido'), 'error');
      }
    })
    .withFailureHandler(function(error) {
      mostrarLoading(false);
      mostrarNotificacion('‚ùå Error del servidor: ' + error.message, 'error');
    })
    .actualizarEstadoRegistro(registroActual.ID, nuevoEstado, '', nombreUser, '');
}

function respuestaCambioEstado(resultado) {
  mostrarLoading(false);
  
  if (resultado && resultado.success) {
    mostrarNotificacion('‚úÖ Estado actualizado correctamente', 'success');
    cerrarModalDetalles();
    cargarDashboard(); // Recargar datos
  } else {
    mostrarNotificacion('‚ùå Error al actualizar estado: ' + (resultado?.message || 'Error desconocido'), 'error');
  }
}

function errorCambioEstado(error) {
  mostrarLoading(false);
  mostrarNotificacion('‚ùå Error del servidor: ' + error.message, 'error');
}

</script>